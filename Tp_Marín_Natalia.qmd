---
title: "Trabajo pr치ctico final IDM"
author: "Natalia Mar칤n"
format: 
  html:
    toc: true      
    toc_float: true  
    number-sections: true
    self-contained: true  # 游댳 Incrusta todos los recursos en el HTML
editor: visual
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

# Introducci칩n

El Banco Central de la Rep칰blica Argentina [BCRA](https://www.bcra.gob.ar/) publica mensualmente un informe consolidado de deudas actuales e hist칩ricas (24 meses), denominado *Central de Deudores del Sistema Financiero*. Este consolidado se elabora en funci칩n de los datos recibidos de distintas entidades financieras, las cuales deben remitir de forma obligatoria y mensual al BCRA, detallando la totalidad de las financiaciones con la correspondiente situaci칩n de cada deudor.

Cada deuda informada al BCRA es acompa침ada de su situaci칩n, una aproximaci칩n a la cantidad de d칤as de atraso en el cumplimiento de pago:

-   Situaci칩n 1 (**Situaci칩n normal**): atraso en el pago que no supere los 31 d칤as.

-   Situaci칩n 2 (**Riesgo bajo**): atraso en el pago de m치s de 31 d칤as y hasta 90 d칤as.

-   Situaci칩n 3 (**Riesgo miedo**): atraso en el pago de m치s de 90 d칤as y hasta 180 d칤as.

-   Situaci칩n 4 (**Riesgo alto**): atraso en el pago de m치s de 180 d칤as a un a침o.

-   Situaci칩n 5 (**Irrecuperable**): atraso superior a un a침o.

-   Situaci칩n 6 (**Irrecuperable por disposici칩n t칠cnica**): deuda con una ex entidad

Se cuenta con una muestra aleatoria de 19.737 CUITs (Clave 칔nica Tributaria) de personas f칤sicas que ten칤an al menos una deuda en el sistema financiero en Junio de 2019, que se encontraban en situaci칩n crediticia 1 o 2, es decir, que no tuvieran atrasos mayores a 90 d칤as y cuyo monto total adeudado en ese momento no superaba los 100.000 pesos argentinos.

Para los CUITs seleccionados en la muestra aleatoria se registraron y resumieron las deudas en todas las entidades en Junio de 2019 y tambi칠n 6 meses hacia atr치s. Tambi칠n se registraron las deudas de esos CUITs entre Julio de 2019 y Junio de 2020 para poder evaluar su evoluci칩n.



```{r}
#| message: false
#| warning: false
library(knitr)
library(gtExtras)
library(tidyverse)
library(kableExtra)
library(psych)
library(corrplot)
library(car)
library(cowplot)
library(ggdendro)
library(caret) 
```

# Definici칩n de variables

```{r}
#| echo: false
#| message: false
#| warning: false
datos <- readRDS("D:/Introducci칩n Data Mining/TP_final/idm_bcra/df_bcra_individuals.rds")

data <- data.frame(
  variable = c(
    "id_individuo", "tipo_persona", "n_deudas_actual", "proxy_edad_actual", 
    "deuda_total_actual", "deuda_con_garantia_actual", "situacion_mes_actual", 
    "prop_con_garantia_actual", "tiene_garantia_actual", "mora_30_dias_mes_actual", 
    "n_meses_seg_bcra", "media_deuda_total", "media_deuda_situacion_1", 
    "media_deuda_situacion_2", "media_deuda_con_garantia", "media_deuda_sin_garantia", 
    "media_deuda_en_default", "max_situacion_mes", "max_sit_mes_con_garantia", 
    "max_sit_mes_sin_garantia", "media_prop_situacion_1", "media_prop_situacion_2", 
    "media_prop_default", "media_prop_con_garantia", "prop_tuvo_garantia", 
    "prop_mora_30_dias_seg", "prop_default_seg", "peor_situacion_respuesta", 
    "default", "mora_mayor_30_dias"
  ),
  detalle = c(
    "identificaci칩n del individuo (anonimizada).", "primeros dos d칤gitos del cuit (20: hombres; 27: mujeres, 23 y 24: repetidos).", 
    "cantidad de entidades en las que el cuit ten칤a al menos una deuda en Jun-2019.", "tres primeros n칰meros del dni.", 
    "monto total de deuda en Jun-2019 (expresada en miles de pesos).", "monto total de deuda garantizada en Jun-2019 (expresada en miles de pesos).", 
    "situaci칩n crediticia m치s grave en todas las deudas del cuit en Jun-2019.", "proporci칩n de la deuda garantizada en Jun-2019", 
    "variable indicadora (0: no, 1: si) de si el cuit ten칤a al menos una deuda garantizada en Jun-2019.", 
    "variable indicadora (0: no, 1: si) de si el cuit estaba en situaci칩n 2 en Jun-2019.", 
    "cantidad de meses en los que el cuit ten칤a al menos una deuda informada en el sistema financiero, entre Dic-2018 y Jun-2019.", 
    "promedio de la deuda total entre Dic-2018 y Jun-2019.", "promedio de la deuda en situaci칩n 1 entre Dic-2018 y Jun-2019.", 
    "promedio de la deuda en situaci칩n 2 entre Dic-2018 y Jun-2019.", "promedio de la deuda garantizada entre Dic-2018 y Jun-2019.", 
    "promedio de la deuda no garantizada entre Dic-2018 y Jun-2019.", 
    "promedio de la deuda en default (situaci칩n 3 o peor) entre Dic-2018 y Jun-2019.", 
    "m치xima situaci칩n entre Dic-2018 y Jun-2019.", "m치xima situaci칩n en las deudas garantizadas entre Dic-2018 y Jun-2019.", 
    "m치xima situaci칩n en las deudas no garantizadas entre Dic-2018 y Jun-2019.", 
    "promedio de la proporci칩n de deuda en situaci칩n 1 entre Dic-2018 y Jun-2019.", 
    "promedio de la proporci칩n de deuda en situaci칩n 2 entre Dic-2018 y Jun-2019.", 
    "promedio de la proporci칩n de deuda en default entre Dic-2018 y Jun-2019.", 
    "promedio de la proporci칩n de deuda garantizada entre Dic-2018 y Jun-2019.", 
    "proporci칩n de meses en los cuales el cuit tuvo deuda garantizada, entre Dic-2018 y Jun-2019.", 
    "proporci칩n de meses en los cuales el cuit estuvo en situaci칩n 2, entre Dic-2018 y Jun-2019.", 
    "proporci칩n de meses en los cuales el cuit estuvo en default, entre Dic-2018 y Jun-2019.", 
    "situaci칩n crediticia m치s grave en todas las deudas del cuit entre Jul-2019 y Jun-2020.", 
    "situaci칩n crediticia m치s grave mayor o igual 3 en todas las deudas del cuit entre Jul-2019 y Jun-2020.", 
    "situaci칩n crediticia m치s grave igual 2 en todas las deudas del cuit entre Jul-2019 y Jun-2020."
  )
)

# Generar la tabla usando kable
kable(
  data,
  col.names = c("Variable", "Detalle"),
  caption = "Tabla 1. Tabla descriptiva de variables."
)
```

# Filtrado y limpieza

Para garantizar la coherencia del an치lisis y enfocarnos en la poblaci칩n de inter칠s, se realiz칩 un filtrado y limpieza de los datos. Se excluyeron aquellos individuos cuya deuda total en junio de 2019 era mayor o igual a 100 mil pesos (1.705 individuos). Esta decisi칩n responde al objetivo del estudio, que busca analizar 칰nicamente a personas con niveles de deuda inferiores a este umbral.

```{r}
individuos_mas100 <- datos %>%
  filter(deuda_total_actual >= 100) %>%
  nrow() #1705 invididuos con deuda mayor a 100 mil pesos

datos<- datos %>%
  filter(deuda_total_actual < 100)

```

# An치lisis exploratorio

Para comenzar el an치lisis de los datos, se utiliz칩 la funci칩n `skim()`, que permite obtener un resumen detallado (*Tabla 2*) de las variables presentes en nuestro *dataset*.

*Tabla 2: Resumen de los datos*

```{r}

skimr::skim(datos)

```

La informaci칩n que se obtiene de este an치lisis es la siguiente:

-   El *dataset* cuenta con 18.032 registros y 30 columnas (variables), con una combinaci칩n de variables categ칩ricas, num칠ricas y una variable del tipo *character*.

-   La variable *character* es la variable `tipo_persona`, los 6 factores son variables relacionadas con la situaci칩n crediticia (por ejemplo `tiene_garantia`) y 23 variables num칠ricas.

-   Algunas variables presentan distribuciones asim칠tricas con valores extremos.

-   Existen variables que tienen naturaleza discreta o categ칩rica, pero actualmente se encuentran en nuestro *dataset* como num칠ricas. Las variables `default`, `mora_mayor_30_dias`, `id_individuo`,`mora_30_dias_mes_actual`,`mora_mayor_30_dias` son factores pero en nuestro dataset se encuentran como variables num칠ricas.

-   Existen valores faltantes en algunas variables, la variable `max_sit_mes_con_garantia` tiene un 97% de valores faltantes y `max_sit_mes_sin_garantia` tambi칠n tiene valores faltantes pero en menor proporci칩n.



```{r}
datos <- datos %>%
  mutate(
    default = as.factor(default),
    mora_mayor_30_dias = as.factor(mora_mayor_30_dias),
    mora_30_dias_mes_actual = as.factor(mora_30_dias_mes_actual),
    id_individuo = as.character(id_individuo),
    tipo_persona= as.factor(tipo_persona)
  )
```

***Nota***: antes de realizar un an치lisis exploratorio m치s detallado y/o aplicar otras t칠cnicas como *matriz de correlaci칩n* o *ACP*, es fundamental asegurarnos de que las variables est칠n correctamente clasificadas seg칰n su naturaleza. Esto se debe a que algunos m칠todos, especialmente aquellos que trabajan con distancias y relaciones lineales entre variables, requieren que las entradas sean de tipo num칠rico.

## An치lisis univariado

### Tipo de persona

En la *Figura 1* se muestra la distribuci칩n de los distintos tipos de persona seg칰n los dos primeros d칤gitos del CUIT. Se observa que las categor칤as m치s representadas son 20 y 27, que corresponden a hombres y mujeres, respectivamente, con una frecuencia similar. Por otro lado, las categor칤as 23 y 24, que tienen una menor presencia, corresponden a registros donde no se puede determinar con certeza el g칠nero de la persona.

```{r}
ggplot(datos, aes(x = as.factor(tipo_persona), fill = as.factor(tipo_persona))) +
  geom_bar() +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Figura 1. Distribuci칩n de tipo de persona",
       x = "Tipo de persona",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none")

```

Dado este patr칩n, se decidi칩 agrupar los tipos de persona en tres categor칤as: Masculino (*tipo de persona = 20*), Femenino (*tipo de persona = 27*) o indeterminado (*tipo de persona igual a 23 o 24*).

```{r}
datos<- datos %>%
  mutate(tipo_persona_cat = case_when(
    tipo_persona == "20" ~ "Hombres",
    tipo_persona == "27" ~ "Mujeres",
    tipo_persona %in% c("23", "24") ~ "Sin definir",
    TRUE ~ "Otros"  # En caso de encontrar valores inesperados
  ))

# Crear la tabla con conteo y porcentaje
tabla_tipo_persona <- datos %>%
  count(tipo_persona_cat) %>%
  mutate(porcentaje = round((n / sum(n)) * 100, 3))

# Mostrar tabla con kable y estilo
kable(tabla_tipo_persona, caption = "Tabla 3: Distribuci칩n de tipo de persona categorizado",
      col.names = c("Tipo de Persona", "Frecuencia", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))



```

La distribuci칩n del tipo de persona categorizada muestra que el 47% corresponden al sexo femenino, 43% al masculino y el resto pertenece a la categor칤a indeterminado.

### N칰mero de deudas actual

La *Figura 2* muestra la frecuencia de deudas por individuo en junio de 2019. Se observa que la mayor칤a de las personas (64%) ten칤a una sola deuda registrada. A medida que aumenta el n칰mero de entidades en las que un individuo ten칤a deudas, la frecuencia disminuye.

```{r}
ggplot(datos, aes(x = as.factor(n_deudas_actual))) +
  geom_bar(fill = "#29508f") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, color = "black") +
  labs(title = "Figura 2. Frecuencia de cantidad de deudas por individuo",
       x = "Cantidad de deudas",
       y = "Frecuencia") +
  ylim(0, 15000) +  # Fijar el l칤mite del eje Y
  theme_minimal()


```

El gr치fico nos sugiere que la mayor칤a de los deudores en la muestra manten칤a relaciones crediticias con una o pocas entidades financieras, mientras que los casos con m칰ltiples deuda en distintas entidades resultan m치s extra침os.

### Proxy edad actual

Al analizar la variable `proxy_edad_actual`, se observa que la mayor칤a de los valores tienen 3 d칤gitos (15.014 observaciones), como se esperar칤a en un identificador basado en los tres primeros n칰meros del DNI. Sin embargo hay 2.922 registros con s칩lo dos d칤gitos y 26 con uno solo, lo que sugiere la posibilidad de un problema en la base de datos, ya sea por errores en a carga de la informaci칩n o porque algunos valores podr칤an haber perdido un cero a la izquierda.

```{r}

# Crear la tabla con conteo y porcentaje
digitos<- datos %>%
  mutate(longitud = nchar(as.character(proxy_edad_actual))) %>%
  count(longitud)

kable(digitos, caption = "Tabla 4: cantidad de d칤gitos en proxy_edad_actual",
      col.names = c("N칰mero de d칤gitos", "Frecuencia"), align = "l") %>%
  kable_styling(full_width = FALSE, position = "left", bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

Para posteriores an치lisis, se hace el supuesto que los registros con menos de 3 d칤gitos corresponden a individuos con DNIs que comienzan con ceros.

En el gr치fico de la *Figura 3* se muestra la distribuci칩n de los tres primeros d칤gitos del DNI. Los valores se distribuyen principalmente entre 100 y 400, con una concentraci칩n relativamente uniforme dentro de este rango.

```{r}

ggplot(datos, aes(x = proxy_edad_actual)) +
  geom_histogram(bins = 15, fill = "#29508f", color = "black") +
  labs(title = "Figura 3. Distribuci칩n de proxy_edad_actual",
       x = "Tres primeros d칤gitos del DNI",
       y = "Frecuencia") +
  theme_minimal()
```

Se registran valores cercanos a cero, que corresponden a aquellos usuarios con menos de 3 d칤gitos. En la muestra obtenida, se obtuvieron pocos valores por encima de 400.

Otra particularidad que se encuentra es que existen dos individuos con los primeros tres d칤gitos mayores a 600. Seg칰n esta [nota](https://www.argentina.gob.ar/interior/dni#:~:text=A%20partir%20de%20septiembre%20de,CUIT%20y%20CUIL%20de%20extranjeros.) se deben a extranjeros.


### Deuda total actual

En la *Figura 4* se observa la distribuci칩n del monto total de deuda en el sistema financiero argentino en junio de 2019, expresado en miles de pesos. Se encuentra una distribuci칩n asim칠trica a la derecha, indicando que la mayor칤a de individuos de la muestra tienen niveles de deuda relativamente bajos, mientras que s칩lo un grupo m치s reducido de personas presenta deudas m치s elevadas.

```{r}
ggplot(datos, aes(x = deuda_total_actual)) +
  geom_histogram(bins = 30, fill = "#29508f", color = "black") +
  labs(title = "Figura 4. Distribuci칩n del monto total de deuda en junio de 2019",
       x = "Deuda total (en miles de pesos)",
       y = "Frecuencia") +
  theme_minimal()


```

A partir de la *Tabla 5*, se encuentra que el monto m칤nimo de deuda registrado en la muestra es de mil pesos, mientras que el m치ximo alcanza el l칤mite de 99 mil pesos. La mediana es de 21 mil pesos, lo que indica que la mitad de los individuos tienen una deuda menor a este valor. Se refuerza lo observado en el histograma, donde la distribuci칩n es asim칠trica a la derecha, con una mayor concentraci칩n de personas con deudas m치s bajas y una cola larga de valores m치s elevados.

```{r}


# 游늷 Crear manualmente el data frame con los valores del summary
resumen_manual <- data.frame(
  Estad칤stica = c("M칤nimo", "1er Cuartil", "Mediana", "Media", "3er Cuartil", "M치ximo"),
  `Deuda_total` = c(1.00, 9.00, 21.00, 29.15, 44.00, 99.00)  # Si necesitas agregar otra variable
)

# 游늷 Mostrar tabla con formato kable
kable(resumen_manual, caption = "Tabla 5: Resumen estad칤stico de deuda_total_actual", align = "l") %>%
  kable_styling(full_width = FALSE, position = "left", bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

### Deuda con garant칤a actual

En la *Figura 5* se muestra la distribuci칩n del monto de deuda garantizada en junio de 2019. La mayor칤a de los individuos de la muestra no tienen deuda garantizada, ya que la mayor concentraci칩n de frecuencia se encuentra en el valor cero.

```{r}
ggplot(datos, aes(x = deuda_con_garantia_actual)) +
  geom_histogram(bins = 5,  fill = "#29508f", color = "black") +
  labs(title = "Figura 5. Distribuci칩n del monto de deuda garantizada en junio de 2019",
       x = "Deuda garantizada (en miles de pesos)",
       y = "Frecuencia") +
  theme_minimal()


```


### Situaci칩n mes actual

En la *Figura 6* se muestra la distribuci칩n de la situaci칩n crediticia m치s grave en todas las deudas de los CUITs de la muestra en junio de 2019. Tal como se esperaba, los valores observados corresponden 칰nicamente a situaci칩n 1 o 2, debido a que la poblaci칩n objetivo de la muestra fue seleccionada bajo el criterio de incluir 칰nicamente a individuos de estas categor칤as.

```{r}

ggplot(datos, aes(x = as.factor(situacion_mes_actual), fill = as.factor(situacion_mes_actual))) +
  geom_bar() +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, color = "black", size = 5) +
  labs(title = "Figura 6. Distribuci칩n de la situaci칩n crediticia en Junio de 2019",
       x = "Situaci칩n crediticia",
       y = "Frecuencia") +
  ylim(0,20000) +  # 游늷 Ajusta el eje y hasta 1800
  theme_minimal() +
  theme(legend.position = "none")


```

Sin embargo, se observa que la proporci칩n de individuos en situaci칩n 2 es de 701 casos, un porcentaje peque침o dentro de la muestra.

### Proporci칩n de deuda garantizada

El an치lisis de la variable `prop_con_garantia_actual` muestra que la mayor칤a de los individuos no tienen ninguna parte de su deuda con garant칤a. Esto se refleja en la mediana y cuartiles observados en la *Tabla 6* que toman valor cero, indicando que al menos el 75% de los individuos no tienen garant칤a alguna.

Este comportamiento est치 alineado con lo observado en la variable previamente analizada, `deuda_con_garantia_actual`, donde se identific칩 este fen칩meno. Sin embargo, podr칤amos analizar para aquellos individuos que s칤 poseen alguna parte de su deuda garantizada, la proporci칩n que se encuentra cubierta por garant칤a.


```{r}

# 游늷 Crear manualmente el data frame con los valores del summary
resumen_manual <- data.frame(
  Estad칤stica = c("M칤nimo", "1er Cuartil", "Mediana", "Media", "3er Cuartil", "M치ximo"),
  `prop_con_garantia_actual` = c(0, 0, 0, 0.014, 0, 1)  # Si necesitas agregar otra variable
)

# 游늷 Mostrar tabla con formato kable
kable(resumen_manual, caption = "Tabla 6: Resumen estad칤stico de prop_con_garantia_actual", align = "l") %>%
  kable_styling(full_width = FALSE, position = "left", bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```



El gr치fico de la *Figura 7* muestra la distribuci칩n de la proporci칩n de deuda garantizada entre aquellos individuos que tienen alguna parte de su deuda con garant칤a (excluyendo a aquellos sin deuda garantizada). Hay individuos con distintos niveles de garant칤a y se observa un pico en el valor 1, lo que indica que una cantidad importante de este subgrupo de individuos tiene toda su deuda garantizada.

```{r}
ggplot(datos %>% filter(prop_con_garantia_actual > 0), aes(x = prop_con_garantia_actual)) +
  geom_histogram(bins = 30, fill = "#29508f",  color = "black") +
  labs(title = "Figura 7. Distribuci칩n de la proporci칩n de deuda garantizada (solo con garant칤a)",
       x = "Proporci칩n de deuda garantizada",
       y = "Frecuencia") +
  theme_minimal()
```

### 쯊iene garant칤a actual?

La variable `tiene_garant칤a_actual` permite identificar de manera binaria a los individuos que ten칤an al menos una parte de su deuda respldada por garant칤a en junio de 2019. Como se observ칩 en los an치lisis de las variables `deuda_con_garantia_actual` y `prop_con_garantia_actual`, la mayor칤a de los individuos no poseen deuda garantizada, confirmado en esta categorizaci칩n.

Los datos de la *Tabla 7* muestran que el 98% de los individuos (17.686) no ten칤an ninguna deuda con garant칤a, mientras que s칩lo casi un 2% contaba con al menos una deuda garantizada.

```{r}
tabla_garantia <- datos %>%
  count(tiene_garantia_actual) %>%
  mutate(proporcion = round((n / sum(n)) * 100, 2))

# 游늷 Crear la tabla con kable y darle formato
tabla_garantia %>%
  kable(
    caption = "Tabla 7: Distribuci칩n de la variable tiene_garantia_actual",
    col.names = c("Tiene Garant칤a", "Frecuencia", "Proporci칩n (%)")
  ) %>%
  kable_styling(full_width = FALSE, position = "left", bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

### 쯉e encuentra en situaci칩n 2 en Junio de 2019?

La variable `mora_30_d칤as_mes_actual` es un indicador que se침ala si un individuo se encontraba en situaci칩n 2 en junio de 2019, es decir, con un atraso en pagos superior a 31 d칤as pero menor a 90 d칤as. Como se observ칩 previamente en la distribuci칩n de la variable `situacion_mes_actual`, la gran mayor칤a de individuos de la muestra se encontraban en situaci칩n 1, mientras s칩lo un peque침o porcentaje ten칤a alg칰n retraso en los pagos. Tal como se observa en la *Tabla 8*, s칩lo un 3,89% de los individuos se encontraba en situaci칩n 2 en Junio de 2019.

```{r}
tabla_mora <- datos %>%
  count(mora_30_dias_mes_actual) %>%
  mutate(proporcion = round((n / sum(n)) * 100, 2))

# 游늷 Crear la tabla con kable y darle formato
tabla_mora %>%
  kable(
    caption = "Tabla 8: Distribuci칩n de la variable mora_30_dias_mes_actual",
    col.names = c("Mora 30 d칤as (Junio 2019)", "Frecuencia", "Proporci칩n (%)")
  ) %>%
  kable_styling(full_width = FALSE, position = "left", bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

### Cantidad de meses con al menos una deuda informada (Dic 2018 - Jun 2019)

La variable `n_meses_seg_bcra` indica la cantidad de meses en los que cada CUIT ten칤a al menos una deuda informada en el sistema financiero argentino entre diciembre de 2018 y junio de 2019.

En la *Figura 8* se muestra la distribuci칩n de la variable, donde la mayor parte de los individuos presentan registros en todos los 7 meses del per칤odo considerado, indicando una presencia constante en el sistema financiero. A medida que disminuye la cantidad de meses con deuda informada, la cantidad de individuos disminuye progresivamente.

```{r}
ggplot(datos, aes(x = as.factor(n_meses_seg_bcra))) +
  geom_bar(fill="#29508f") +
  geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, color = "#29508f", size = 5) +
  labs(title = "Figura 8. Cantidad de meses con deuda informada (Dic 2018 - Jun 2019)",
       x = "Cantidad de meses con deuda",
       y = "Frecuencia") +
  theme_minimal() +
  ylim(0, 15000) +  # 游늷 Ajusta el eje y hasta 15000
  theme(legend.position = "none")


```

### Promedios de deuda seg칰n tipo y situacion crediticia (Dic 2018 - Jun 2019)

Dado que las variables `media_deuda_total`, `media_deuda_situacion_1` ,`media_deuda_situacion_2`, `media_deuda_con_garantia`, `media_deuda_sin_garantia`y `media_deuda_en_default` representan promedios deuda en distintos contextos (total, garantizada, sin garant칤a, en mora, en *default*), se decidi칩 analizarlas en conjunto a trav칠s de la *Tabla 9* resumen.

```{r}

# 游늷 Crear tabla manualmente con los valores de resumen
tabla_resumen <- data.frame(
  Variable = c("Media Deuda Total", "Media Deuda Situaci칩n 1", "Media Deuda Situaci칩n 2",
               "Media Deuda con Garant칤a", "Media Deuda sin Garant칤a", "Media Deuda en Default"),
  Min = c(1.00, 0.00, 0.0000, 0.000, 0.00, 0.000),
  `1st Qu.` = c(10.43, 10.00, 0.0000, 0.000, 10.00, 0.000),
  Median = c(22.50, 21.57, 0.0000, 0.000, 21.71, 0.000),
  Mean = c(31.03, 30.18, 0.5525, 1.049, 29.98, 0.301),
  `3rd Qu.` = c(44.50, 43.17, 0.0000, 0.000, 42.83, 0.000),
  Max = c(207.86, 207.86, 94.0000, 140.571, 207.86, 96.571)
)

# 游늷 Mostrar tabla con `kable`
kable(tabla_resumen, caption = "Tabla 9: Resumen estad칤stico de variables de deuda",
      col.names = c("Variable", "M칤nimo", "1er Cuartil", "Mediana", "Media", "3er Cuartil", "M치ximo")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

El promedio de la deuda total es de 31,03 miles de pesos con una mediana de 22,5 miles de pesos. Se observa un rango amplio, con valores que van desde mil hasta los 207 mil pesos. La mayor parte de la deuda total se encuentra en situaci칩n 1 (normal), con un promedio de 30,18 mil pesos, cercano al promedio de la deuda total. Por otro lado, se observa que el 75% de los individuos tienen un promedio de deuda en mora (situaci칩n 2) igual a 0, lo que indica que la morosidad es un fen칩meno poco frecuente en la muestra. Sin embargo, el valor m치ximo llega a 94 mil pesos, sugiriendo que algunos individuos presentan altos valores de deuda en situaci칩n de mora. Como se observ칩 con anterioridad, la mayor칤a de individuos de la muestra no tienen deuda garantizada. El promedio de deuda garantizada es s칩lo de 1,049 mil pesos, confirmando la baja incidencia de este tipo en la muestra. A pesar de ello, hay casos donde la deuda garantizada alcanza los 140,57 mil pesos, lo que sugiere que existen ciertos individuos con deuda con garant칤a. Para el caso de aquellos individuos sin garant칤a, el promedio de deuda es de 29,98 mil pesos, similar al promedio de la deuda total (lo cual tiene sentido siendo que la mayor칤a de individuos no tiene deuda garantizada). La mediana de la deuda en *default* es igual a 9 lo que significa que la mayor칤a de los individuos no tienen deudas en situaci칩n 3 o peor. Sin embargo, el valor m치ximo de 96,57 nos muestra que existen individuos en la muestra con altos niveles de deuda en incumplimiento.


### M치ximos de situaciones crediticias (Dic 2018 - Jun 2019)

Las variables `max_situacion_mes`, `max_sit_mes_con_garantia` y `max_sit_mes_sin_garantia` representan la m치xima situaci칩n crediticia que un individuo alcanz칩 en el per칤odo de tiempo analizado, tanto en t칠rminos generales como diferenciado entre deuda garantizada y no garantizada.

El gr치fico de la *Figura 9* muestra la distribuci칩n de la m치xima situaci칩n crediticia alcanzada por los individuos en el per칤odo analizado. La mayor칤a de los individuos alcanzaron un m치ximo de situaci칩n 1 (normal), s칩lo un peque침o porcentaje alcanz칩 la situaci칩n 2 o peor. Esto significa que un grupo reducido de la muestra experiment칩 atrasos en sus pagos en alg칰n momento del per칤odo.

```{r}

# Transformar los datos a formato largo para mejor visualizaci칩n
datos_long <- datos %>%
  pivot_longer(cols = c(max_situacion_mes, max_sit_mes_con_garantia, max_sit_mes_sin_garantia),
               names_to = "tipo_situacion", values_to = "situacion")

# Gr치fico de barras
ggplot(datos_long, aes(x = as.factor(situacion), fill = tipo_situacion)) +
  geom_bar(position = "dodge") +
  labs(title = "Figura 9. M치xima Situaci칩n Crediticia Alcanzada (Dic 2018 - Jun 2019)",
       x = "M치xima Situaci칩n Crediticia",
       y = "Frecuencia",
       fill = "Tipo de Situaci칩n") +
  theme_minimal()
```

La presencia de valores faltantes (NA) es un punto importante en la interpretaci칩n. Esto ocurre porque la mayor칤a de individuos no tienen deuda garantizada, por lo que su m치xima situaci칩n crediticia en este tipo de deuda no est치 definida y por eso queda vac칤a. No representa un error en los datos, sino que refleja que aquellos individuos sin deuda garantizada simplemente no tienen una situaci칩n crediticia registrada en esta categor칤a.

### Proporciones de deuda seg칰n situaci칩n y garant칤a (Dic 2018 - Jun 2019)

En este apartado se analizar치n las siguientes variables que representan proporciones de deuda o de meses con determinada condici칩n crediticia: `media_prop_situacion_1`,`media_prop_situacion_2`, `media_prop_default`, `media_prop_con_garantia`, `prop_tuvo_garantia`, `prop_mora_30_dias_seg` y `prop_default_seg`.

Estas variables permiten evaluar la estabilidad financiera de los individuos de la muestra, observando qu칠 porcentaje de su deuda (o de los meses analizados) estuvo en diferentes condiciones de riesgo o fue respaldada con garant칤a.

```{r}
# 游늷 Crear tabla manualmente con los valores de resumen
tabla_resumen_10 <- data.frame(
  Variable = c("Media Prop. Situaci칩n 1", "Media Prop. Situaci칩n 2", "Media Prop. Default",
               "Media Prop. Con Garant칤a", "Prop. Tuvo Garant칤a", "Prop. Mora 30 d칤as seg.",
               "Prop. Default seg."),
  Min = c(0.0000, 0.00000, 0.000000, 0.00000, 0.0000, 0.00000, 0.00000),
  `1st Qu.` = c(1.0000, 0.00000, 0.000000, 0.00000, 0.0000, 0.00000, 0.00000),
  Median = c(1.0000, 0.00000, 0.000000, 0.00000, 0.0000, 0.00000, 0.00000),
  Mean = c(0.9741, 0.01724, 0.008683, 0.01582, 0.0209, 0.04516, 0.01764),
  `3rd Qu.` = c(1.0000, 0.00000, 0.000000, 0.00000, 0.0000, 0.00000, 0.00000),
  Max = c(1.0000, 1.00000, 0.857143, 1.00000, 1.0000, 1.00000, 0.85714)
)

# 游늷 Mostrar tabla con `kable`
kable(tabla_resumen_10, caption = "Tabla 10: Resumen Estad칤stico de Variables de Proporciones",
      col.names = c("Variable", "M칤nimo", "1er Cuartil", "Mediana", "Media", "3er Cuartil", "M치ximo")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

En la *Tabla 10* se encuentra que la proporci칩n de deuda en situaci칩n 1 es predominante, lo que confirma que la mayor칤a de individuos mantuvieron su deuda en condici칩n normal durante el per칤odo. En contraste, la proporci칩n de deuda en situaci칩n 2 es m치s baja, indicando que al menos el 75% de los individuos de la muestra no present칩 mora. Sin embargo, hay casos donde el 100% de la deuda estuvo en mora. La proporci칩n de deuda en *default* es a칰n m치s reducida, con una media de 0,87% y valores m치ximos de 85,7%, evidenciando que muy pocos individuos tuvieron un incumplimiento severo en la muestra. Esto concuerda con la baja incidencia de situaciones de riesgo observada previamente. Respecto a la proporci칩n de deuda garantizada, la media de 1,58% y la mediana de 0% refuerzan la conclusi칩n previa de que la mayor칤a de individuos no ten칤a deuda garantizada. De manera similar, la proporci칩n de meses con garant칤a es m칤nima, con valores concentrados en 0% reafirmando la baja presencia de estos casos. Finalmente, las proporciones de meses en mora y *default* presentan valores promedio de 4,5% y 1,76%, respectivamente, indicando que la gran mayor칤a de individuos no tuvo un deterioro crediticio de manera recurrente. Dicho esto, existen casos con alta exposici칩n al riesgo, lo que podr칤a justificar un an치lisis m치s detallado de estos perfiles.

### Peor situaci칩n crediticia alcanzada (Jul 2019 - Jun 2020)

La variable `peor_situacion_respuesta` representa la situaci칩n crediticia m치s grave que un individuo de la muestra experiment칩 en cualquier momento entre julio de 2019 y junio 2020. Dado que la muestra conten칤a s칩lo individuos en situaci칩n 1 o 2 en junio de 2019, es interesante observar cu치ntos lograron mantener su estado crediticio y cu치ntos experimentaron un deterioro. En la *Figura 10* se observa que la mayor칤a de los casos mantuvieron su deuda en situaci칩n normal. Un porcentaje menor de la muestra experiment칩 un deterioro financiero.

```{r}


# Gr치fico de barras con etiquetas
ggplot(datos, aes(x = as.factor(peor_situacion_respuesta))) +
  geom_bar(fill = "#29508f") +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5) +
  labs(title = "Figura 10. Distribuci칩n de la Peor Situaci칩n Crediticia (Jul 2019 - Jun 2020)",
       x = "Peor Situaci칩n Crediticia",
       y = "Frecuencia") +
  theme_minimal()

```

Para evaluar la evoluci칩n crediticia con un poco m치s de profundidad, se presenta a continuaci칩n una tabla de contingencia que compara la situaci칩n de individuos a junio de 2019 con la peor situaci칩n alcanzada en el per칤odo julio 2019 - junio 2020.

```{r}
library(janitor)


# 游늷 Crear la tabla de contingencia
tabla_situacion <- datos %>%
  tabyl(situacion_mes_actual, peor_situacion_respuesta) %>%
  adorn_totals(where = "row") %>%
  adorn_totals(where = "col")


# 游늷 Mostrar la tabla con kable
kable(tabla_situacion, caption = "Tabla 11: Relaci칩n entre Situaci칩n Crediticia en Junio 2019 y Peor Situaci칩n Posterior") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

En la *Tabla 11* se observa que la mayor칤a de individuos que comenzaron en situaci칩n 1 lograron mantener esta categor칤a. Un grupo reducido en situaci칩n2 logr칩 mejorar su perfil crediticio al pasar a situaci칩n 1. Sin embargo, se observa un deterioro en 1.738 personas que pasaron de una situaci칩n 1 a categor칤as de mayor riesgo y 424 personas en situaci칩n 2 tambi칠n tuvieron una peor situaci칩n, alcanzando niveles de mora m치s graves. En total, 1.573 terminaron en situaci칩n 3 o peor, lo que indica un incremento del riesgo de *default*

### Default

La variable `default` indica si un individuo alcanz칩 una situaci칩n crediticia de 3 o peor en cualquier momento entre julio de 2019 y junio de 2020. La *Figura 11* muestra la distribuci칩n de individuos en *default* en este per칤odo. Se observa que la gran mayor칤a de individuos (aproximadamente el 91,3%) no ingresaron en situaci칩n de incumplimiento, mientras que 1.573 individuos (8,7%) s칤 alcanzaron el estado de *default*.

```{r}

ggplot(datos, aes(x = as.factor(default), fill = as.factor(default))) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5) +
  scale_fill_manual(values = c("steelblue", "red")) +
  labs(title = "Figura 11. Distribuci칩n de Individuos en Default (Jul 2019 - Jun 2020)",
       x = "Estado de Default",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none")

```

Este tipo de variable suele ser utilizada como variable respuesta en modelos de predicci칩n de riesgo crediticio, ya que permite anticipar las posibilidades de que un individuo entre en incumplimiento. Sin embargo, el desbalance observado en esta muestra podr치 representar luego un desaf칤o metodol칩gico.

### Mora mayor 30 d칤as (Jul 2019 - Jun 2020)

La variable `mora_mayor_30_dias` indica si un individuo tuvo una situaci칩n crediticia igual a 2 en todas sus deudas durante el per칤odo de julio 2019 a junio de 2020. A diferencia de la variable `default`, que captura los estados de incumplimientos severo (situaci칩n 3 o peor), esta variable permite identificar individuos que, si bien no entraron en *default*, presentaron atrasos de m치s de 30 d칤as en sus pagos.

En la *Figura 12* se observa que aproximadamente el 84% de las personas no incurrieron en atrasos prolongados, mientras que el restante 16% si tuvo al menos una deuda en situaci칩n 2 pero sin caer en *default*.

```{r}
ggplot(datos, aes(x = as.factor(mora_mayor_30_dias), fill = as.factor(mora_mayor_30_dias))) +
  geom_bar() +
  geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.5) +
  scale_fill_manual(values = c("steelblue", "orange")) +
  labs(title = "Figura 12. Distribuci칩n de Individuos en Mora Mayor a 30 D칤as (Jul 2019 - Jun 2020)",
       x = "Estado de Mora (>30 d칤as)",
       y = "Frecuencia") +
  theme_minimal() +
  theme(legend.position = "none")

```

Los resultados tienen coherencia con tabla de contingencia de situaciones crediticia analizada previamente, donde se observ칩 que algunos individuos en situaci칩n 1 y 2 en junio de 2019 evolucionaron hacia estados de mayor riesgo

## Comentarios sobre el an치lisis exploratorio

El an치lisis exploratorio realizado permiti칩 comprender la distribuci칩n y evoluci칩n de la situaci칩n crediticia de los individuos de la muestra, as칤 como identificar patrones clave en su comportamiento financiero. Se observ칩 que la mayor칤a de los individuos mantuvo una situaci칩n crediticia estable en el per칤odo analizado, aunque un grupo de personas experiment칩 un deterioro en su situaci칩n crediticia, alcanzando situaciones m치s riesgosas, incluso el *default*. El an치lisis mostr칩 que muchas de las variables est치n altamente relacionadas o se derivan entre s칤, como por ejemplo `situacion_mes_actual`, `peor_situacion_repuesta`,`default` o `mora_mayor_30_dias`, lo que sugiere redundancia en la informaci칩n. Esto ser치 un aspecto importante a considerar en posteriores an치lisis.

# Correlaci칩n entre posibles predictoras de default

Para analizar las posibles relaciones entre las variables predictoras de `default`, se calcular치 la **matriz de correlaciones** de las variables disponibles a junio de 2019. Este an치lisis permitir치 identificar qu칠 variables est치n fuertemente correlacionadas entre s칤, lo que tambi칠n puede indicar una redundancia de informaci칩n o la existencia de relaciones esperadas entre los indicadores financieros.

Antes de calcular la matriz de correlaciones es fundamental asegurarnos de que solo se incluyan las variables num칠ricas.

*Figura 13. Matriz de correlaci칩n*
```{r}
library(corrplot)


predictoras_default <- datos %>%
  select(proxy_edad_actual,deuda_total_actual, deuda_con_garantia_actual, prop_con_garantia_actual,
         media_deuda_total,media_deuda_situacion_1,media_deuda_situacion_2,media_deuda_con_garantia,media_deuda_sin_garantia, media_deuda_en_default, media_prop_situacion_1,media_prop_situacion_2, media_prop_default,media_prop_con_garantia,prop_tuvo_garantia, prop_mora_30_dias_seg,prop_default_seg)


# 游늷 Calcular la matriz de correlaciones
matriz_corr <- cor(predictoras_default, use = "complete.obs")

# 游늷 Ajustar el margen superior para m치s espacio en el t칤tulo
par(mar = c(5, 5, 8, 2))  # Aumenta el tercer valor (margen superior)

# 游늷 Visualizar la matriz de correlaciones
corrplot(matriz_corr, method = "color", type = "upper", tl.cex = 0.5, number.cex = 0.5,
         col = colorRampPalette(c("blue", "white", "red"))(200), addCoef.col = "black",
         tl.col = "black", tl.srt = 90)

# 游늷 Agregar el t칤tulo con m치s separaci칩n



```

A partir de la matriz de correlaciones de la *Figura 13* se encuentran las siguientes observaciones:

- Alta correlaci칩n entre la `deuda_total_actual` y `media_deuda_total` (*0.83*), lo cual es esperable, ya que individuos con mayores niveles de deuda en un mes probablemente hayan mantenido un patr칩n similar a lo largo del tiempo.

- Alta correlaci칩n entre `media_deuda_situacion_1` y `deuda_total_actual` (*0.83*), reforzando lo observado en el an치lisis exploratorio, la mayor parte de la deuda se encuentra en situaci칩n 1.

- Alta correlaci칩n entre `media_deuda_situacion_1` y `media_deuda_total` (*0.99*), casi correlaci칩n perfecta, indica que la deuda total promedio est치 casi completamente explicada por la deuda en situaci칩n 1.

- Alta correlaci칩n entre `media_prop_con_garantia` y `prop_con_garantia_actual` (*0.92*), lo que sugiere que el nivel de deudas se mantiene constante para la mayor칤a de individuos, como se ha observado en el an치lisis exploratorio previo.

- La correlaci칩n entre `prop_con_garantia_actual`y `prop_tuvo_garantia` de *0.87* muestra que la proporci칩n deuda garantizada en junio de 2019 est치 altamente correlacionada con la proporci칩n de meses que un individuo tuvo deuda garantizada.

- La alta correlaci칩n entre `media_deuda_total`y `media_deuda_sin_garantia` de *0.96* indica que la mayor parte de la deuda total promedio est치 relacionada a la deuda sin garant칤a. Esto sugiere a que la mayor칤a de individuos acceden a financiamiento sin respaldo de garant칤as.

- La fuerte correlaci칩n negativa entre `prop_mora_30_dias_seg` y `media_prop_situacion_1` (*-0.86*), es consistente con la l칩gica financiera: aquellos con una alta proporci칩n de deuda en situaci칩n 1 tienen menos chances de haber estado en mora durante el per칤odo de an치lisis.

- La variable `proxy_edad_actual` tiene correlaci칩n casi nula con el resto de las variables.

## Comentarios sobre la matriz de correlaciones

Las correlaciones analizadas sugieren que el comportamiento crediticio de los individuos tiende a ser estable a lo largo del tiempo, tanto en t칠rminos de garant칤as como de cumplimiento de pagos. Sin embargo, tambi칠n reflejan una posible redundancia en ciertas variables, como en el caso de la deuda garantizada y su proporci칩n a lo largo del tiempo. Esto debe ser considerado en posteriores an치lisis para evitar duplicidad de informaci칩n en modelos y segmentaci칩n de clientes.

# An치lisis de componentes principales

El **An치lisis de Componentes Principales** (ACP) es una t칠cnica 칰til en este caso porque permite reducir la dimensionalidad del conjunto de datos mientras se conserva la mayor parte de la variabilidad original. Dado que observamos correlaciones altas entre varias variables, el ACP nos ayudar치 a identificar combinaciones lineales de estas que expliquen la mayor parte de la informaci칩n sin redundancia. Esto tambi칠n puede contribuir a mejorar el desempe침o de modelos predictivos al minimizar el problema de colinealidad.

A continuaci칩n se presenta una serie de pasos para el c치lculo, elecci칩n e interpretaci칩n de las componentes principales.

## C치lculo de las componentes principales

Para este an치lisis consideramos las mismas variables de la matriz de correlaci칩n, calculada previamente con variables a junio de 2019.

*Nota: se excluyeron las variables n_deudas_actual y n_meses_seg_bcra, a pesar de ser num칠ricas, debido a que toman un n칰mero reducido de valores discretos y presentan una alta concentraci칩n en una o dos categor칤as, presentando distribuci칩n asim칠trica. Incluir estas variables puede impactar el c치lculo de las componentes con una influencia que no aporta variabilidad real al modelo. La variable proxy_edad_actual tambi칠n fue excluida debido a su baja correlaci칩n con el resto de las variables.*

Se aplica el ACP con normalizaci칩n autom치tica (`scale.unit=TRUE`) para trabajar con la matriz de correlaci칩nes (*matriz R*). Este paso es necesario porque las variables tienen diferentes escalas (por ejemplo, algunas est치n en miles de pesos y otras son proporciones que var칤an de 0 a 1).

```{r}
#| echo: false
#| message: false
#| warning: false


predictoras_default <- datos %>%
  select(deuda_total_actual, deuda_con_garantia_actual, prop_con_garantia_actual,
         media_deuda_total,media_deuda_situacion_1,media_deuda_situacion_2,media_deuda_con_garantia,media_deuda_sin_garantia, media_deuda_en_default, media_prop_situacion_1,media_prop_situacion_2, media_prop_default,media_prop_con_garantia,prop_tuvo_garantia, prop_mora_30_dias_seg,prop_default_seg)
# Cargar las librer칤as
library(FactoMineR)   # Para realizar el ACP
library(factoextra)   # Para visualizar los resultados del ACP
library(ggplot2)      # Para gr치ficos adicionales

acp_resultado <- PCA(predictoras_default, scale.unit = TRUE, graph = FALSE)
```

## Analizar la varianza explicada

Se desea conocer cu치nto de la variabilidad total logran explicar las primeras componentes. El *gr치fico de codo* o *scree plot* nos muestra la varianza explicada por cada componente.

```{r}
# Gr치fico de codo para ver cu치ntas componentes retener
fviz_eig(acp_resultado, addlabels = TRUE, ylim = c(0, 100),main="Figura 14.Scree plot") 

```

El gr치fico de la *Figura 14* muestra que las dos primeras componentes explican conjuntamente la mitad (56.1%) de la variabilidad total de los datos, mientras que las tres primeras componentes alcanzan un 77.7%. A partir de la cuarta componente, la variancia explicada decrece a un ritmo mayor, lo que sugiere que la mayor parte de la informaci칩n se resumen en las primeras dimensiones.

El patr칩n observado en el gr치fico es com칰n en *datasets* con alta redundancia o multicolinealidad. Dado que previamente observamos en la matriz de correlaciones que muchas variables estaban altamente correlacionadas entre s칤, era esperable que el ACP condensara la informaci칩n en pocas dimensiones.

En t칠rminos pr치cticos, la reducci칩n de dimensionalidad es 칰til para identificar los principales ejes de variabilidad en el perfil crediticio de los individuos y facilitar su interpretaci칩n.

## An치lisis de las contribuciones

Las contribuciones de las variables indican cu치nto aporta cada una a la construcci칩n de una determinada componente principal. Esto nos ayuda a identificar qu칠 dimensiones resumen mejor la informaci칩n original y c칩mo se pueden interpretar en t칠rminos de las variables m치s influyentes.

```{r, echo=FALSE, message=FALSE}


# Obtener la tabla de contribuciones
contribuciones <- as.data.frame(acp_resultado$var$contrib)

# Mostrar las variables que m치s contribuyen a las primeras tres dimensiones en formato kable
kable(contribuciones[,1:3], digits = 2, caption = "Tabla 12. Contribuci칩n de las variables a las primeras tres dimensiones del ACP") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

```{r}
fviz_contrib(acp_resultado, choice = "var", axes = 1, top = 10) +
  labs(title = "Figura 15. Contribuci칩n de variables a la Dimensi칩n 1") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

A partir de la *Tabla 12* y la *Figura 15* se observa que las variables m치s relevantes en la primera componente est치n relacionadas con la presencia de garant칤as en las deudas (`media_deuda_con_garantia`,`media_prop_con_garantia`, `prop_tuvo_garantia` y `prop_con_garantia_actual`).

```{r}
fviz_contrib(acp_resultado, choice = "var", axes = 2, top = 10) +
  labs(title = "Figura 16. Contribuci칩n de variables a la Dimensi칩n 2") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

En base a lo observado en la *Tabla 12* y la *Figura 16* la segunda componente pareciera estar capturando aspectos relacionados con el **riesgo crediticio y deterioro financiero** de los individuos.

```{r}
fviz_contrib(acp_resultado, choice = "var", axes = 3, top = 10) +
  labs(title = "Figura 17. Contribuci칩n de variables a la Dimensi칩n 3") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

A partir de la *Tabla 12* y *Figura 17* se sugiere que la tercera dimensi칩n tres puede estar capturando una diferencia entre los individuos con deuda sin garant칤a y los que tienen garant칤a.

## An치lisis de las cargas

Las cargas factoriales indican la correlaci칩n entre cada variable original y las componentes principales. En otras palabras, reflejan cu치nto representa cada variable en cada dimensi칩n. Mientras las contribuciones nos dicen qu칠 variables dominan una componente, las cargas nos permiten interpretar que significa cada componente en t칠rminos de las variables originales.

La *Tabla 13* muestra la relaci칩n entre las variables originales y las tres primeras componentes principales.

```{r, echo=FALSE, message=FALSE}


# Obtener la tabla de contribuciones
correlacioness <- as.data.frame(acp_resultado$var$cor)

# Mostrar las variables que m치s contribuyen a las primeras tres dimensiones en formato kable
kable(correlacioness[,1:3], digits = 2, caption = "Tabla 13. Cargas factoriales en las dimensiones principales") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))


```

La primera componente principal mide el **nivel de deuda garantizada**, diferenciando a quienes poseen deudas con garant칤as de aquellos con deuda no respaldada. Individuos con valores altos en la primera dimensi칩n tienen un mayor acceso a cr칠dito garantizado. La segunda dimensi칩n separa deudores de bajo riesgo de aquellos con *default* o mora alta. Valores negativos indican situaciones crediticias m치s estables, mientras que valores positivos reflejan mayor riesgo financiero. Esta variable podr칤a pensarse como una medida del **riesgo crediticio**. La tercera componente diferencia a los individuos con deuda sin respaldo (tendr치n valores altos) y aquellos con mayor proporci칩n de deuda garantizada (valores negativos). Separa personas que dependen de financiamiento sin respaldo de quienes acceden a cr칠ditos con garant칤a.

A mi parecer, las dimensiones 1 y 2 capturan las diferencias m치s importantes en la cartera crediticia.

## Diferenciar individuos seg칰n el tipo de persona

Para evaluar si las componentes principales logran diferencias los CUITs seg칰n el tipo de persona podemos visualizar la distribuci칩n de los individuos en el espacio de las dos primeras dimensiones del ACP, pintando los puntos seg칰n su categor칤a (Masculino, Femenino, Indeterminado).

```{r}
# Convertir los resultados del ACP en un dataframe y agregar la variable 'tipo_persona_cat'
df_ind <- as.data.frame(acp_resultado$ind$coord)
df_ind$tipo_persona_cat <- as.factor(datos$tipo_persona_cat)  # Convertir a factor por segu

fviz_pca_ind(acp_resultado, 
             habillage = df_ind$tipo_persona_cat,  
             addEllipses = TRUE,  
             ellipse.type = "confidence",
             geom = "point",  # Solo puntos, sin etiquetas
             palette = c("#E41A1C", "#377EB8", "#4DAF4A"),  
             title = "Figura 18. Diferenciaci칩n de CUITs seg칰n tipo de persona")


```

La *Figura 18* que muestra gr치fico de dispersi칩n en las dos primeras componentes principales muestra que no existe una diferenciaci칩n clara entre los CUITs seg칰n el tipo de persona. Se observa que la mayor칤a de los puntos est치n cercanos al origen, lo que sugiere que la mayor칤a de los individuos tienen valores bajos en ambas dimensiones (endeudamiento con garant칤a bajo y bajo riesgo).

En el gr치fico se observa una l칤nea recta que podr칤a explicarse por el uso de proporciones (la suma de algunas proporciones podr칤an generar alineaciones en el espacio) o bien por la estructura del cr칠dito. En el an치lisis exploratorio se observ칩 que gran parte de los individuos no ten칤a deuda garantizada, lo que puede generar esta estructura alineada en el espacio de representaci칩n.


# Segmentaci칩n de CUITs


**쮼xisten distintos subgrupos de CUITs en los datos? 쮺u치ntos logra identificar? 쯈u칠 caracter칤sticas tienen?**

Se ha optado por la aplicaci칩n del algoritmo *K-means*, un m칠todo de *clustering* muy utilizado debido a su eficiencia computacional y su capacidad para segmentar grandes vol칰menes de datos num칠ricos. En este caso, la medida de similitud empleada es la distancia *eucl칤dea*, adecuada para variables continuas, que permite minimizar la variancia *intra-cluster*. 

Es necesario recordar que el conjunto de datos tambi칠n incluye variables categ칩ricas, como la situaci칩n crediticia, el tipo de persona y la presencia o ausencia de garant칤as financieras. Para manejar este tipo de informaci칩n, una alternativa com칰n es el uso de la distancia de *Gower*, que permite calcular similitudes en daos mixtos. Sin embargo, este enfoque presenta una desventaja en t칠rminos de costo computacional, ya que requiere construir y almacenar una matriz de distancia de tama침o $NxN$, lo que resulta ineficiente en estudios como este, donde se trabaja con un tama침o de muestra considerable. Otra posibilidad ser칤a convertir las variables categ칩ricas en variables *dummy* y luego aplicar *K-means*.

En este caso se opt칩 por una tercera alternativa: construir los *clusters* utilizando las dos primeras componentes del ACP realizado previamente junto con las variables num칠ricas que no fueron incluidas en dicho an치lisis. 

Una vez obtenidos los *clusters*, se analizar치 la distribuci칩n de cada grupo y su relaci칩n con las variables categ칩ricas, permitiendo interpretar c칩mo estos factores se asocian con los grupos identificados. 

## Elecci칩n de n칰mero de clusters


Antes de aplicar el algoritmo *K-means*, es fundamental escalar las variables num칠ricas para garantizar que todas tengan la misma influencia en la segmentaci칩n. Esto se debe a que *K-means* utiliza la distancia *eucl칤dea*, la cual es sensible a las diferencias de escala entre variables. Para ello, se emplea la estandarizaci칩n, que transforma las variables a una media de 0 y una desviaci칩n est치ndar de 1.

Para determinar el n칰mero 칩ptimo de clusters, se ha optado por el criterio del Silhouette Score. Este m칠todo mide qu칠 tan bien se encuentra cada observaci칩n dentro de su grupo en comparaci칩n con otros grupos, proporcionando una m칠trica que var칤a entre -1 y 1. Un valor cercano a 1 indica que las observaciones est치n bien agrupadas, mientras que valores cercanos a 0 o negativos sugieren que podr칤an estar mejor ubicadas en otro cluster.

El n칰mero 칩ptimo de clusters se selecciona observando en qu칠 punto el Silhouette Score alcanza su m치ximo, asegurando una segmentaci칩n que refleje patrones reales dentro de los datos.
```{r}
# 游늷 1. Cargar librer칤as necesarias
library(tidyverse)
library(cluster)  
library(FactoMineR)
library(factoextra)  

# 游늷 2. Extraer las dos primeras Componentes Principales (CP1 y CP2) del ACP
pca_df <- data.frame(CP1 = acp_resultado$ind$coord[,1], 
                     CP2 = acp_resultado$ind$coord[,2])

# 游늷 3. Seleccionar las variables originales adicionales para el clustering
vars_extra <- datos %>%
  select(n_deudas_actual, proxy_edad_actual, n_meses_seg_bcra)

# 游늷 4. Combinar CP1, CP2 y las variables seleccionadas
clustering_data <- bind_cols(pca_df, vars_extra) %>% scale()  # Normalizar variables



# 游늷 Generar el gr치fico con t칤tulo
fviz_nbclust(clustering_data, kmeans, method = "silhouette") +
  ggtitle("Figura 19. N칰mero 칩ptimo de clusters m칠trica Silhouette") +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))




```

En la *Figura 19* se muestra la evaluaci칩n del n칰mero 칩ptimo de *clusters* utilizando el *칤ndice de Silhouette*. Se observa que el pico m치ximo del 칤ndice ocurre en `k=6`, lo que sugiere que es el n칰mero de segmentaci칩n 칩ptima seg칰n esta m칠trica.

El gr치fico de la *Figura 20*  representa la segmentaci칩n obtenida tras aplicar el algoritmo de *K-means* sobre las dos primeras CP. Cada punto de visualizaci칩n corresponde a un individuo de la muestra y su color se refiere al *cluster* al que pertenece. Las regiones sombreadas delimitan el espacio de cada grupo. 

```{r}
# 游늷 6. Aplicar K-means con el n칰mero 칩ptimo de clusters (ejemplo con 3)
set.seed(17)
kmeans_result <- kmeans(clustering_data, centers = 6, nstart = 50)

# 游늷 7. Agregar los clusters al dataframe original
datos$cluster <- as.factor(kmeans_result$cluster)


fviz_cluster(kmeans_result, data = clustering_data, geom = "point", ellipse = TRUE) +
  ggtitle("Figura 20. Distribuci칩n de Clusters") +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))


```


Algunos, como el *cluster 1 *y el *cluster 6*, presentan una separaci칩n m치s clara del resto, lo que sugiere que estos grupos tienen caracter칤sticas bien diferenciadas. Otros *clusters*, como los grupos 2, 3 y 4, muestran cierta superposici칩n, lo que indica que podr칤an compartir similitudes en algunas dimensiones mientras que se diferencian en otras variables no representadas en este gr치fico.


## Caracter칤sticas de los clusters

El an치lisis *cluster* nos permite identificar los grupos con caracter칤sticas crediticias similares a partir de la segmentaci칩n generada por *K-means*. Para comprender mejor las diferencias entre *clusters*, analizaremos su composici칩n en funci칩n de variables num칠ricas y categ칩ricas, lo que permitir치 interpretar los patrones que explican la formaci칩n de cada grupo.



### Respecto a las variables num칠ricas

Se examina la distribuci칩n de los *clusters* en relaci칩n con las variables num칠ricas utilizadas en el an치lisis. 
```{r}
# 游늷 Cargar librer칤a necesaria
# 游늷 Agregar CP1 y CP2 al dataframe original
df <- datos %>%
  bind_cols(pca_df) %>%  # Agregar las CP1 y CP2 desde pca_df
  mutate(cluster = as.factor(cluster))  # Asegurar que cluster sea factor

# 游늷 Calcular la media de CP1, CP2 y otras variables por cluster
resumen_clusters <- df %>%
  group_by(cluster) %>%
  summarise(
    Media_CP1 = mean(CP1, na.rm = TRUE),
    Media_CP2 = mean(CP2, na.rm = TRUE),
    Media_n_deudas = mean(n_deudas_actual, na.rm = TRUE),
    Media_proxy_edad = mean(proxy_edad_actual, na.rm = TRUE),
    Media_meses_seg_bcra = mean(n_meses_seg_bcra, na.rm = TRUE),
    Cantidad_individuos = n()  # Cantidad de CUITs en cada cluster
  )



```



*Figura 20. Distribuci칩n de variables continuas por cluster*
```{r}

library(ggplot2)
library(cowplot)  # Para combinar gr치ficos

# 游늷 Funci칩n para generar boxplots por cluster
generar_boxplots_por_grupos <- function(df, var_interes, grupos = "cluster") {
  
  # Asegurar que el cluster es factor
  df[[grupos]] <- as.factor(df[[grupos]])
  
  # Generar el gr치fico de boxplot
  ggplot(df, aes_string(x = grupos, y = var_interes, fill = grupos)) +
    geom_boxplot() +
    theme_minimal() +
    theme(legend.position = "none") +
    scale_x_discrete(name = paste0(grupos)) +
    scale_y_continuous(name = paste0(var_interes)) +
    geom_hline(yintercept = median(df[[var_interes]], na.rm = TRUE), 
               linetype = "dashed", color = "red") +
    theme(axis.text.x = element_text(size = rel(0.75)))
}

# 游늷 Generar boxplots para cada variable relevante
g1 <- generar_boxplots_por_grupos(df, "CP1")
g2 <- generar_boxplots_por_grupos(df, "CP2")
g3 <- generar_boxplots_por_grupos(df, "n_deudas_actual")
g4 <- generar_boxplots_por_grupos(df, "proxy_edad_actual")
g5 <- generar_boxplots_por_grupos(df, "n_meses_seg_bcra")

# 游늷 Combinar todos los gr치ficos en una grilla (2 columnas)
plot_grid(g1, g2, g3, g4, g5, ncol = 2)

```

- **Distribuci칩n de CP1**: se observa que la mayor칤a de los *clusters* presentan valores de CP1 cercanos a cero. Sin embargo, el *cluster 4* se destaca con una mediana mucho m치s elevada en comparaci칩n a los dem치s grupos. Tambi칠n presenta una mayor variabilidad respecto a los dem치s grupos. Dado que CP1 mide el nivel de deuda garantizada, el gr치fico sugiere que los individuos de este grupo tienen mayor deuda garantizada respecto a los dem치s.

- **Distribuci칩n de CP2**: dado que esta dimensi칩n captura el riesgo crediticio, donde valores negativos indican mayor estabilidad financiera y valores positivos reflejan mayor riesgo, se sugiere que el *cluster 5* se distingue del resto por tener altos valores de CP2. Esto implica que los individuos en este grupo est치n asociados con un riesgo financiero muy alto. Por otro lado, el *cluster 4* tiene valores de CP2 negativos, indicando que en este grupo existe una mejor situaci칩n crediticia.

- **Distribuci칩n de n칰mero de deudas**: se observa que el *cluster 2* tiene un mayor n칰mero de deudas en promedio, con una mediana m치s alta en comparaci칩n con los dem치s *clusters*. 

- **Distribuci칩n de proxy edad**: la variable `proxy_edad_actual` toma valores m치s altos cuando el individuo es m치s joven (o extranjero) y valores m치s bajos corresponden a personas de una edad m치s avanzada. El *cluster 6* se destaca por tener los valores de *proxy* bajos, indicando que este grupo est치 compuesto por individuos de mayor edad, mientras que el *cluster 3* presentan valores de edad m치s altos, lo que sugiere que est치 conformado por individuos m치s j칩venes.

- **Distribuci칩n de meses con deuda**: se observa que los *clusters 2 a 6* tienen una gran concentraci칩n en el valor m치ximo, lo que sugiere que la mayor칤a de los individuos de estos grupos han estados en el sistema financiero durante todo el per칤odo considerado. En contraste, el *cluster 1*, se diferencia de los dem치s al presentar valores m치s bajos, con una mediana cercana a los 3 meses y un rango intercuartil m치s amplio. Esto sugiere que los individuos de este grupo tienen una presencia m치s reciente o intermitente en el sistema financiero.

### Respecto a variables categ칩ricas


Analizaremos la distribuci칩n de los clusters en las variables categ칩ricas, como la situaci칩n crediticia, la presencia de mora y la existencia de garant칤as. Esto permitir치 evaluar si ciertos clusters est치n m치s asociados con perfiles de alto riesgo financiero o si existen diferencias en la composici칩n de los grupos seg칰n el tipo de persona o la estabilidad crediticia.
```{r}
#| message: false
#| warning: false
#| include: false
# 游늷 Cargar librer칤as necesarias
library(dplyr)
library(ggplot2)

# 游늷 Lista de variables categ칩ricas a analizar
categorical_vars <- c("tipo_persona_cat", "situacion_mes_actual", "tiene_garantia_actual",
                      "mora_30_dias_mes_actual", "max_situacion_mes")

# 游늷 Funci칩n para generar tablas de frecuencia cruzada
generar_tabla_frecuencia <- function(var) {
  tabla <- datos %>%
    group_by(cluster, .data[[var]]) %>%
    summarise(count = n(), .groups = "drop") %>%
    mutate(percent = round(count / sum(count) * 100, 2))
  
  print(tabla)  # Mostrar la tabla en consola
  
  return(tabla)
}

# 游늷 Generar tablas de frecuencia para cada variable categ칩rica
tablas_frecuencia <- lapply(categorical_vars, generar_tabla_frecuencia)

# 游늷 Funci칩n para generar gr치ficos de barras apiladas por cluster (uno por uno)
# 游늷 Funci칩n para generar gr치ficos de barras apiladas por cluster
graficar_categoricas <- function(var) {
  ggplot(datos, aes(x = cluster, fill = as.factor(.data[[var]]))) +
    geom_bar(position = "fill") +  # Barras apiladas en proporciones
    labs(title = paste( var),
         x = "Cluster", y = "Proporci칩n",
         fill = var) +
    scale_y_continuous(labels = scales::percent_format()) +
    theme_minimal()
}


```

*Figura 21. Distribuci칩n de variables categ칩ricas  por cluster*
```{r}

library(gridExtra)  # Para organizar los gr치ficos en una grilla

# 游늷 Generar todos los gr치ficos y almacenarlos en una lista
graficos <- lapply(categorical_vars, graficar_categoricas)

# 游늷 Mostrar los gr치ficos en una grilla de 2 columnas y 3 filas
do.call(grid.arrange, c(graficos, ncol = 2))

```

- La distribuci칩n por **tipo de persona** muestra en t칠rminos generales parecer칤a ser similar a trav칠s de los 6 *clusters*. S칩lo en el *cluster 4* se evidencia una mayor proporci칩n de hombres.

- En cuanto a la variable **situaci칩n_mes_actual**, la mayor칤a de los individuos en todos los *clusters* se encuentran en situaci칩n 1. El *cluster 5* es el que presenta la mayor proporci칩n de individuos en situaci칩n 2.

- La distribuci칩n de la variable indicadora **tiene_garant칤a** muestra que el *cluster 4* es el 칰nico grupo con mayor proporci칩n de individuos con deuda garantizada.

- El *cluster 5* es el grupo con mayor proporci칩n de individuos en **mora de m치s de 30 d칤as**, lo que sugiere un mayor nivel de riesgo crediticio dentro de este segmento. Este patr칩n coincide con el an치lisis previo de CP2, donde el *cluster 5* mostraba los valores m치s altos, lo que refuerza la idea de que este grupo concentra a los individuos con mayor riesgo financiero.

- Se observa que el *cluster 5* es el 칰nico grupo con varias **situaciones crediticias m치ximas**, en especial las m치s graves, confirmando que este *cluster* concentra el mayor riesgo financiero. Los *clusters 1,3 y 6* est치n casi completamente compuestos por individuos en situaci칩n 1, lo que sugiere perfiles de menor riesgo. Estos resultados refuerzan la segmentaci칩n observada previamente en CP2 y mora de 30 d칤as, donde el *cluster 5* se destacaba como el de mayor exposici칩n a incumplimientos.


## Conclusiones sobre los clusters

En t칠rminos generales, seg칰n lo observado podr칤a pensarse en cada *cluster* como:

- **Cluster 1**: Perfil financiero estable, sin mora significativa ni deudas garantizadas. Principalmente en situaci칩n 1.

- **Cluster 2**: Similar a *Cluster 1*, pero con una ligera presencia de mora y mayor n칰mero de deudas en distintas entidades.

- **Cluster 3**: Composici칩n equilibrada, con algunos individuos de menor edad y una baja presencia de mora o riesgo crediticio.

- **Cluster 4**: Se diferencia por una alta proporci칩n de deuda garantizada y menor riesgo crediticio. 

- **Cluster 5**: Mayor riesgo financiero. Alta presencia de mora, *default* y m칰ltiples deudas. Se concentra el mayor porcentaje de individuos en situaciones cr칤ticas.

- **Cluster 6**: Similar a *clusters 1 y 3*, con perfiles de mayor edad y sin grandes niveles de mora o riesgo financiero.

# Modelo predictivo para la variable default

El objetivo de esta secci칩n es construir modelos predictivos que estimen la probabilidad de *default* (`default`=1), utilizando 칰nicamente las variables disponibles a junio de 2019.

Para garantizar una comparaci칩n justa, se usar치 la misma partici칩n de datos en los tres modelos. Adem치s, se evaluar치 la capacidad predictiva con m칠tricas de clasificaci칩n y curvas ROC.

## Preparaci칩n de datos y particionamiento

Antes de entrenar los modelos, es importante preparar los datos. Este proceso incluye la selecci칩n de variables predictoras, el manejo de valores faltantes y la divisi칩n en conjuntos de entrenamiento y prueba.

La base de datos se particiona en 80% para entrenamiento y 20% para prueba. Esta divisi칩n permite que los modelos aprendan a partir de una porci칩n de los datos y luego sean evaluados en un conjunto independiente, lo que ayuda a medir su capacidad de generalizaci칩n a nuevos casos.

```{r}
#| message: false
#| warning: false
# 游늷 Cargar librer칤as necesarias
library(tidyverse)
library(caret)
library(randomForest)
library(rpart)
library(rpart.plot)
library(pROC)

# 游늷 Definir las variables predictoras excluyendo la variable objetivo "default"
variables_pred <- c("tipo_persona", "n_deudas_actual", "proxy_edad_actual", "deuda_total_actual", 
                    "deuda_con_garantia_actual", "situacion_mes_actual", "prop_con_garantia_actual", 
                    "tiene_garantia_actual", "mora_30_dias_mes_actual", "n_meses_seg_bcra",
                    "media_deuda_total", "media_deuda_situacion_1", "media_deuda_situacion_2",
                    "media_deuda_con_garantia", "media_deuda_sin_garantia", "media_deuda_en_default",
                    "max_situacion_mes", "max_sit_mes_con_garantia", "max_sit_mes_sin_garantia",
                    "media_prop_situacion_1", "media_prop_situacion_2", "media_prop_default",
                    "media_prop_con_garantia", "prop_tuvo_garantia", "prop_mora_30_dias_seg",
                    "prop_default_seg")

# 游늷 Crear dataset con variables seleccionadas
datos_modelo <- datos %>% select(all_of(variables_pred), default)

# 游늷 Convertir variable objetivo a factor para clasificaci칩n
datos_modelo$default <- as.factor(datos_modelo$default)

# 游늷 Manejar valores faltantes (reemplazar NA en variables espec칤ficas)
datos_modelo <- datos_modelo %>%
  mutate(
    max_sit_mes_con_garantia = ifelse(is.na(max_sit_mes_con_garantia), 0, max_sit_mes_con_garantia),
    max_sit_mes_sin_garantia = ifelse(is.na(max_sit_mes_sin_garantia), 0, max_sit_mes_sin_garantia)
  )

# 游늷 Partici칩n en entrenamiento (80%) y prueba (20%)
set.seed(123)
trainIndex <- createDataPartition(datos_modelo$default, p = 0.8, list = FALSE)
trainData <- datos_modelo[trainIndex, ]
testData  <- datos_modelo[-trainIndex, ]


```

## Entrenamiento de modelos

En esta secci칩n se entrenan m칰ltiples modelos de clasificaci칩n para predecir el *default*. Se consideran los siguienes modelos:

-   **Modelo 1 - Random Forest con variables originales**: un ensamble de 치rboles de decisi칩n que mejora la generalizaci칩n a reducir la variancia del modelo.

-   **Modelo 2 - Random Forest optimizado**: se ajusta `mtry`mediante validaci칩n cruzada y se seleccinan las variables m치s importantes observadas en el Modelo 1.

-   **Modelo 3 - 츼rbol de decisi칩n CART**: un modelo interpretable que permite visualizar reglas de decisi칩n simples. Se establece un criterio de poca y profundidad m치xima para evitar sobreajuste.

-   **Modelo 4 - Random Forest con CP y variables no resumidas en la t칠cnica**: se entrena al modelo con las dos primeras componentes principales extra칤das en el ACP, adem치s de variables categ칩ricas y discretas no incluidas en dicho an치lisis.

Cada modelo se entrenar치 sobre el mismo conjunto de entrenamiento para asegurar una comparaci칩n justa y evitar sesgos en la evaluaci칩n.

### Modelo 1: Random Forest con variables originales

El primer modelo implementado es un *Random Forest* sin optimizaci칩n, utilizando todas las variables disponibles hasta junio de 2019. Este enfoque permite evaluar un punto de referencia sobre la capacidad predictiva del modelo antes de aplicar estrategias de optimizaci칩n.

Se construye con 500 치rboles (`ntree=500`) permitiendo una mejor estimaci칩n de la importancia de las variables. No se ajuste el hiperpar치metro `mtry` (cantidad de variables evaluadas en cada divisi칩n), utilizando en su lugar un valor predeterminado.

Dado que la variable objetivo `default` est치 altamente desbalanceada, se espera que el modelo tenga un alto desempe침o en la clase mayoritaria (sin *default*), pero un bajo desempe침o en la detecci칩n de casos con *default*.

```{r}
# 游늷 Entrenar modelo Random Forest
set.seed(123)
modelo_rf <- randomForest(default ~ ., data = trainData, 
                          ntree = 500, 
                          mtry = sqrt(ncol(trainData) - 1),  # N칰mero de predictores en cada split
                          importance = TRUE)

# 游늷 Evaluar importancia de variables
varImpPlot(modelo_rf, main = "Figura 22. Importancia de Variables - Random Forest")

```

El gr치fico de importancia de variables de la *Figura 22* generado a partir del modelo permite identificar qu칠 variables tienen mayor influencia en la predicci칩n del *default*.

La m칠trica *Mean Decrease Accuracy* eval칰a cu치nto disminuye la precisi칩n del modelo si se excluye una variable del modelo. En este caso las variables con mayor impacto son `media_deuda_situacion_1`,`media_deuda_total`,`media_deuda_sin_garantia`,`n_deudas_actual`,`deuda_total_actual` y `n_meses_seg_bcra`.

Por otra parte, la m칠trica *Mean Decrease Gini*, mide la capacidad de una variable de dividir correctamente las clases en cada nodo del 치rbol.Valores m치s altos indican mayor capacidad discriminatoria. Las variables con mayor contribuci칩n resultaron: `proxy_edad_actual`, `media_prop_situacion_1`, `media_deuda_situacion_1`, `media_deuda_total`, `media_deuda_sin_garantia`,`deuda_total_actual` y`prop_mora_30_dias_seg`.

Algunas variables que tienen baja importancia en ambas m칠tricas como `tiene_garantia_actual`,`max_sit_mes_con_garantia` y `prop_con_garantia_actual` podr칤an ser eliminadas para reducir la complejidad del modelo.

### Modelo 2: Random Forest optimizado

Se optimiza el modelo probando diferentes valores de `mtry`, se excluyen variables poco relevantes seg칰n la importancia en el Random Forest base y se reemplaza `proxy_edad_actual` por `grupo_edad`.

```{r}
#| message: false
#| warning: false
# 游늷 Definir variables optimizadas
variables_opt <- c("tipo_persona", "n_deudas_actual", "proxy_edad_actual", "deuda_total_actual", 
                   "deuda_con_garantia_actual", "situacion_mes_actual", "n_meses_seg_bcra",
                   "media_deuda_total", "media_deuda_situacion_1", "media_deuda_situacion_2",
                   "media_deuda_con_garantia", "media_deuda_sin_garantia", "media_deuda_en_default",
                   "max_situacion_mes", "media_prop_situacion_1", "media_prop_situacion_2",
                   "media_prop_default", "media_prop_con_garantia", "prop_tuvo_garantia",
                   "prop_mora_30_dias_seg")

# 游늷 Crear dataset optimizado
trainData_opt <- trainData %>% select(all_of(variables_opt), default)
testData_opt  <- testData %>% select(all_of(variables_opt), default)

# 游늷 Convertir variable objetivo a factor
trainData_opt$default <- as.factor(trainData_opt$default)
testData_opt$default  <- as.factor(testData_opt$default)


```


*Figura 23: Valor de mtry 칩ptimo*
```{r}
# 游늷 Optimizaci칩n de `mtry`
set.seed(123)
best_mtry <- tuneRF(
  x = trainData_opt[,-which(names(trainData_opt) == "default")], 
  y = trainData_opt$default, 
  stepFactor = 1.5, improve = 0.01, ntreeTry = 500, trace = FALSE
)

# 游늷 Extraer mejor valor de `mtry`
best_mtry_value <- best_mtry[which.min(best_mtry[,2]), 1]


```

Seg칰n la *Figura 23* el mejor valor para `mtry` resulta ser 4.

```{r}
# 游늷 Entrenar Random Forest optimizado
set.seed(123)
modelo_rf_opt <- randomForest(
  default ~ ., data = trainData_opt, 
  ntree = 1000,  
  mtry = best_mtry_value,  
  importance = TRUE
)

# 游늷 Visualizar la importancia de las variables
varImpPlot(modelo_rf_opt, main = "Figura 24. Importancia de Variables - RF Optimizado")

```

El an치lisis de importancia de variables (*Figura 24*) confirma la relevancia del historial de endeudamiento y la evoluci칩n de la situaci칩n crediticia como los principales factores predictivos del default. Variables como la cantidad de deudas, la proporci칩n de deuda en distintas situaciones y los montos hist칩ricos son clave para la predicci칩n.

### Modelo 3: CART

El modelo CART, a diferencia de los modelos basados en conjuntos como *Random Forest*, permiten generar reglas de clasificaci칩n simples y f치cilmente interpretables. En este caso, se entrena un modelo CART con una profundidad m치xima de 4, (`maxdepth=4`) para mantener un balance entre interpretabilidad y desempe침o predictivo. Esta restricci칩n evita el riesgo de sobreajuste.


*Figura 25. 츼rbol de decisi칩n CART*
```{r}
# 游늷 Entrenar modelo CART
set.seed(123)
modelo_cart <- rpart(default ~ ., data = trainData, method = "class",
                     control = rpart.control(cp = 0.01, minsplit = 20, maxdepth = 4))

# 游늷 Visualizar el 치rbol de decisi칩n
rpart.plot(modelo_cart, type = 4, extra = 104, tweak = 1.2, main = "츼rbol de Decisi칩n CART")

```

El 치rbol CART se basa en reglas secuenciales, evaluando variables en distintos niveles (*Figura 25*):

-   **Primer nivel**: variable `media_prop_situacion_1` (proporci칩n de deuda en situaci칩n 1). Si la proporci칩n de deuda en situaci칩n 1 es mayor o igual a 0.97, el individuo tiene muy baja probabilidad de estar en *default* (5%). Si la proporci칩n de deuda en situaci칩n 1 es menor a 0.97, se analiza la situaci칩n crediticia en el mes actual.

-   **Segundo nivel**: variable `situacion_mes_actual` (situaci칩n crediticia m치s grave en junio de 2019). Si la situaci칩n registrada m치s grave es 1 (situaci칩n normal), el individuo sigue teniendo bajo riesgo de *default* (29%).

-   **Tercer nivel**: variable `media_deuda_situacion_2` (Proporci칩n de deuda en situaci칩n 2): si la proporci칩n de deuda en situaci칩n 2 es menos a 0.73, la probabilidad de *default* es 34%, mientras que si es mayor o igual, la probabilidad de estar en *default* aumenta al 66%.

### Modelo 4: Random Forest con CP

En este modelo, se busca meorar la capacidad predictiva del *Random Forest* incorporando transformaciones de variables y reducci칩n de dimensionalidad mediante el ACP realizado previamente. Para ello, se incluye:

-   Las dos primeras CP obtenidas en el ACP realizado previamente. Las primeras dos dimensiones del ACP resumen la informaci칩n contenida en m칰ltiples variables num칠ricas altamente correlacionadas, reduciendo la dimensionalidad del problema y ayudando a evitar redundancia en los predictores.

-   Variables no incluidas en el ACP como `tipo_persona_cat`, `n_deudas_actual` y `situacion_mes_actual`, `proxy_edad_actual`, que pueden aportar informaci칩n relevante sobre el riesgo de *default*.

```{r}

variables_pred_4 <- c("tipo_persona_cat", "n_deudas_actual", "proxy_edad_actual",
                       "situacion_mes_actual",
                      "tiene_garantia_actual","mora_30_dias_mes_actual", "max_situacion_mes", "max_sit_mes_con_garantia", "max_sit_mes_sin_garantia", 
                      "deuda_total_actual", "situacion_mes_actual", "n_meses_seg_bcra")


variables_opt <- c("tipo_persona", "n_deudas_actual", "proxy_edad_actual", 
                    "n_meses_seg_bcra", "max_situacion_mes")
datos_pca <- as.data.frame(acp_resultado$ind$coord[, 1:2])  # Solo tomamos las dos primeras CPs
colnames(datos_pca) <- c("Dim.1", "Dim.2")  # Renombramos para mayor claridad

# 游늷 Agregar estas dimensiones a la base de datos original
datos <- cbind(datos, datos_pca)  # A침adir Dim.1 y Dim.2 a 'datos'

variables_pred_4 <- c(variables_pred_4, "Dim.1", "Dim.2")  # Se agregan las CPs
datos_modelo_4 <- datos %>% select(all_of(variables_pred_4), default)


datos_modelo_4 <- datos_modelo_4 %>%
  mutate(
    max_sit_mes_con_garantia = ifelse(is.na(max_sit_mes_con_garantia), 0, max_sit_mes_con_garantia),
    max_sit_mes_sin_garantia = ifelse(is.na(max_sit_mes_sin_garantia), 0, max_sit_mes_sin_garantia)
  )
datos_modelo_4$default <- as.factor(datos_modelo_4$default)
set.seed(123)
trainData_4 <- datos_modelo_4[trainIndex, ]
testData_4  <- datos_modelo_4[-trainIndex, ]

```

Se entrena el *Random Forest* con 500 치rboles y un subconjunto de predictores igual a 4 (`mtry=4`).

```{r}
# 游늷 Entrenar Modelo Random Forest con Variables Transformadas + ACP
set.seed(123)
modelo_rf_4 <- randomForest(default ~ ., data = trainData_4, ntree = 500, 
                            mtry = 4, importance = TRUE)

# 游늷 Evaluaci칩n del modelo en conjunto de prueba
predicciones_rf_4 <- predict(modelo_rf_4, newdata = testData_4, type = "class")

# 游늷 Matriz de confusi칩n
conf_matrix_rf_4 <- confusionMatrix(predicciones_rf_4, testData_4$default)

# 游늷 Importancia de variables
varImpPlot(modelo_rf_4, main = "Figura 26. Importancia de Variables - Random Forest")

```

Se observa en la *Figura 26* que las CP incluidas han absorbido gran parte de la informaci칩n de las variables originales, reduciendo la dimensionalidad sin perder el poder predictivo. De todas maneras, el modelo sigue considerando factores claves como la cantidad de deudas, el historial de mora y la situaci칩n crediticia.

## Evaluaci칩n de modelos

Una vez entrenados los modelos, es importante evaluar su capacidad predictiva para determinar cu치l de ellos ofrece el mejor desempe침o en la predicci칩n del `default`. Para ello se utilizar치n distintas m칠tricas de clasificaci칩n, incluyendo:

-   **Accuracy**: Proporci칩n de predicciones correctas sobre el total de observaciones.

-   **Sensitivity**: Capacidad del modelo para identificar correctamente los casos de *default* (clase positiva).

-   **Specificity**: Capacidad del modelo para identificar correctamente los casos de no `default` (clase negativa).

-   **Precision** (Pos Pred Value - PPV): Proporci칩n de predicciones positivas que realmente corresponden a un *default*.

-   **Negative Predictive Value** (NPV): Proporci칩n de predicciones negativas que realmente corresponden a no *default*.

Dado que el objetivo es detectar correctamente los casos de `default = 1`, debemos asegurarnos de que la clase positiva en confusionMatrix() sea 1, ya que por defecto se toma 0.

La *Tabla Y* presenta una evaluaci칩n comparativa de los cuatro modelos predictivos en t칠rminos de diferentes m칠tricas de clasificaci칩n.

```{r}
# 游늷 Funci칩n para evaluar modelos con clase positiva = 1
evaluar_modelo <- function(modelo, testData) {
  pred <- predict(modelo, testData, type = "class")  # Predicciones
  cm <- confusionMatrix(pred, testData$default, positive = "1")  # Definir clase positiva como 1
  return(cm)
}
# 游늷 Evaluar cada modelo en el conjunto de prueba
cm_rf     <- evaluar_modelo(modelo_rf, testData)
cm_rf_opt <- evaluar_modelo(modelo_rf_opt, testData)
cm_cart   <- evaluar_modelo(modelo_cart, testData)
cm_rf_4   <- evaluar_modelo(modelo_rf_4, testData_4)  # Si usa otra partici칩n, ajusta testData_4
# 游늷 Crear tabla con m칠tricas clave y redondear a 3 decimales
metricas_comparacion <- data.frame(
  Modelo = c("Random Forest", "Random Forest Optimizado", "CART", "Random Forest (CPs + Variables Transformadas)"),
  Accuracy = round(c(cm_rf$overall["Accuracy"], cm_rf_opt$overall["Accuracy"], cm_cart$overall["Accuracy"], cm_rf_4$overall["Accuracy"]), 3),
  Sensitivity = round(c(cm_rf$byClass["Sensitivity"], cm_rf_opt$byClass["Sensitivity"], cm_cart$byClass["Sensitivity"], cm_rf_4$byClass["Sensitivity"]), 3),
  Specificity = round(c(cm_rf$byClass["Specificity"], cm_rf_opt$byClass["Specificity"], cm_cart$byClass["Specificity"], cm_rf_4$byClass["Specificity"]), 3),
  Precision = round(c(cm_rf$byClass["Pos Pred Value"], cm_rf_opt$byClass["Pos Pred Value"], cm_cart$byClass["Pos Pred Value"], cm_rf_4$byClass["Pos Pred Value"]), 3),
  Neg_Predictive_Value = round(c(cm_rf$byClass["Neg Pred Value"], cm_rf_opt$byClass["Neg Pred Value"], cm_cart$byClass["Neg Pred Value"], cm_rf_4$byClass["Neg Pred Value"]), 3)
)

# 游늷 Mostrar tabla con knitr::kable()
kable(metricas_comparacion, caption = "Tabla 14. Comparaci칩n de Modelos con Clase Positiva = Default (1)")


```

La tabla de m칠tricas de los modelos evaluados (*Tabla 14*) muestra que todos los modelos tienen una alta precisi칩n general (*accuracy* aproximado de 91.8%), lo que indica que en t칠rminos generales clasifican correctamente la mayor칤a de las observaciones. Sin embargo, al analizar m칠tricas m치s espec칤ficas, se observa un problema clave: la sensibilidad (*recall*) es baja en todos los modelos, situ치ndose entre 22.9% y 26.4%. Esto significa que los modelos no detectan bien los casos de *default* (`default = 1`), clasificando err칩neamente a muchos individuos en riesgo como no morosos.

Por otro lado, la especificidad es extremadamente alta (\> 97%), lo que indica que los modelos son muy efectivos en clasificar correctamente a los individuos que no est치n en *default* (`default = 0`). Es decir, los modelos est치n sesgados hacia la clase mayoritaria, lo que genera una alta cantidad de falsos negativos (personas que realmente est치n en *default* pero fueron clasificadas como no morosas).

El valor predictivo positivo (precisi칩n) es alto, lo que significa que cuando un modelo predice *default*, en la mayor칤a de los casos acierta. Sin embargo, dado que la sensibilidad es baja, muchos individuos en riesgo real de *default* est치n siendo ignorados, lo que en un contexto financiero puede representar un alto riesgo.

El *Negative Predictive Value* (NPV), que mide qu칠 tan confiables son las predicciones de no *default* (`default = 0`), es relativamente bajo (entre 0.93 y 0.94), lo que refuerza la idea de que los modelos est치n dejando escapar muchos casos de *default*.

Comparar los modelos en t칠rminos del 츼rea Bajo la Curva (AUC - ROC), que mide la capacidad del modelo para discriminar entre los casos de *default* (`default= 1`) y no *default* (`default= 0`).

En la *Figura 27* se muestran las curvas ROC de los cuatro modelos analizados. Estas curvas reflejan la relaci칩n entre la tasa de verdaderos positivos y la tasa de falsos negativos, proporcionando una imagen visual del desempe침o de cada modelo.

```{r}
# 游늷 Cargar librer칤as necesarias
library(pROC)
library(ggplot2)

# 游늷 Obtener probabilidades en lugar de clases para cada modelo
prob_rf <- predict(modelo_rf, testData, type = "prob")[,2]
prob_rf_opt <- predict(modelo_rf_opt, testData, type = "prob")[,2]
prob_cart <- predict(modelo_cart, testData, type = "prob")[,2]
prob_rf_4 <- predict(modelo_rf_4, testData_4, type = "prob")[,2]  # testData_4 si el set es distinto

# 游늷 Calcular curvas ROC y AUC individualmente
roc_rf <- roc(testData$default, prob_rf)
roc_rf_opt <- roc(testData$default, prob_rf_opt)
roc_cart <- roc(testData$default, prob_cart)
roc_rf_4 <- roc(testData_4$default, prob_rf_4)  # testData_4 si es diferente

# 游늷 Crear el gr치fico ROC con m칰ltiples l칤neas
ggplot() +
  geom_line(aes(x = 1 - roc_rf$specificities, y = roc_rf$sensitivities, color = "Random Forest"), size = 1) +
  geom_line(aes(x = 1 - roc_rf_opt$specificities, y = roc_rf_opt$sensitivities, color = "Random Forest Optimizado"), size = 1) +
  geom_line(aes(x = 1 - roc_cart$specificities, y = roc_cart$sensitivities, color = "CART"), size = 1) +
  geom_line(aes(x = 1 - roc_rf_4$specificities, y = roc_rf_4$sensitivities, color = "Random Forest (CPs + Variables Transformadas)"), size = 1) +
  geom_abline(linetype = "dashed") +
  labs(title = "Figura 27. Curvas ROC Comparativas",
       x = "Tasa de Falsos Positivos (1 - Especificidad)",
       y = "Tasa de Verdaderos Positivos (Sensibilidad)") +
  theme_minimal() +
  theme(legend.title = element_blank(), legend.position = "bottom")

# 游늷 Mostrar AUC de cada modelo
auc_rf <- auc(roc_rf)
auc_rf_opt <- auc(roc_rf_opt)
auc_cart <- auc(roc_cart)
auc_rf_4 <- auc(roc_rf_4)

auc_values <- data.frame(
  Modelo = c("Random Forest", "Random Forest Optimizado", "CART", "Random Forest (CPs + Variables Transformadas)"),
  AUC = round(c(auc_rf, auc_rf_opt, auc_cart, auc_rf_4), 3)
)



```

```{r}
# 游늷 Mostrar tabla con AUC en formato knitr
library(knitr)
kable(auc_values, caption = "Tabla 15. 츼rea Bajo la Curva (AUC) para cada Modelo")


```

El modelo *RF Optimizado* es el m치s robusto, aunque la mejora respecto al RF Base es m칤nima (de 0.799 a 0.800). El *modelo CART* es el menos efectivo, con un AUC inferior a 0.75, lo que implica que su capacidad predictiva es menor. La inclusi칩n de las CP en lugar de las variables cuantitativas no gener칩 una mejora significativa, por lo que los modelos con las variables originales son suficientes para capturar la variabilidad en la predicci칩n del *default*.

## Conclusiones sobre los modelos propuestos

***쯋tilizar칤a el modelo construido para evaluar futuros solicitantes de un cr칠dito?***

A partir de la evaluaci칩n de los modelos construidos, se observa que, si bien presentan una alta precisi칩n general, muestran una baja especificidad, lo que significa que tienen dificultades para detectar correctamente a los individuos que efectivamente caer치n en *default*. Este es un problema cr칤tico, ya que el principal objetivo del modelo es identificar con precisi칩n a los solicitantes con mayor riesgo de incumplimiento.

El modelo *Random Forest optimizado* mostr칩 un desempe침o ligeramente superior en t칠rminos de AUC, lo que indica una mejor capacidad discriminatoria. Sin embargo, la baja sensibilidad en la detecci칩n de casos *default* implica que el modelo sigue clasificando err칩neamente como solventes a individuos que en realidad podr칤an no pagar sus deudas.

Las soluciones que se proponen son las siguientes:

-   **Ajustar el umbral de clasificaci칩n**: Reducir el umbral de decisi칩n (por ejemplo, de 0.5 a 0.3) puede ayudar a mejorar la sensibilidad, permitiendo capturar m치s casos de default, aunque a costa de un mayor n칰mero de falsos positivos.

-   **Obtener m치s informaci칩n**: Si se cuenta con datos adicionales sobre historial crediticio, ingresos u otras variables relacionadas con el comportamiento financiero, esto podr칤a mejorar la capacidad predictiva del modelo.

-   **Manejo del desbalance de clases**: Implementar t칠cnicas de reescalado de pesos en el modelo, sobremuestreo de la clase minoritaria o submuestreo de la clase mayoritaria podr칤a ayudar a mejorar la detecci칩n de los casos de default.

-   **Explorar otros modelos**: Modelos como Gradient Boosting (XGBoost o LightGBM) o regresi칩n log칤stica podr칤an ser m치s efectivos para capturar patrones m치s complejos en los datos y mejorar la clasificaci칩n de los casos de default.

Si bien el modelo actual ofrece una buena precisi칩n general, no es completamente confiable para la evaluaci칩n de futuros solicitantes de cr칠dito debido a su baja sensibilidad en la detecci칩n de aquellos en riesgo de default. Antes de implementarlo en un entorno real, se recomienda mejorar la estrategia de modelado mediante ajustes en el umbral de clasificaci칩n, manejo del desbalance y exploraci칩n de modelos m치s avanzados.



# Conclusiones finales

El an치lisis realizado permiti칩 comprender la din치mica crediticia de los individuos y segmentarlos en grupos con caracter칤sticas diferenciadas. A trav칠s del an치lisis exploratorio, se identific칩 que la mayor칤a de los individuos mantuvo una situaci칩n crediticia estable, aunque un subconjunto experiment칩 un deterioro financiero, alcanzando niveles de mora o *default*. Las correlaciones observadas indicaron estabilidad en el comportamiento crediticio a lo largo del tiempo, pero tambi칠n reflejaron redundancia en algunas variables.

La aplicaci칩n del An치lisis de Componentes Principales permiti칩 reducir la dimensionalidad de los datos. La primera dimensi칩n reflej칩 el acceso a cr칠dito garantizado, mientras que la segunda represent칩 el nivel de riesgo financiero, diferenciando a los individuos en funci칩n de su estabilidad crediticia. A partir de estas dimensiones, se logr칩 una segmentaci칩n efectiva mediante *K-means*, identificando seis *clusters* con perfiles distintos en t칠rminos de deuda, mora y garant칤as.

Si bien los modelos de predicci칩n presentaron una alta precisi칩n general, mostraron dificultades para identificar correctamente a los individuos en *default*, lo que resalta la necesidad de ajustar la estrategia de clasificaci칩n. El uso de t칠cnicas como la modificaci칩n del umbral de decisi칩n, el manejo del desbalance de clases y la exploraci칩n de modelos alternativos podr칤a mejorar la capacidad del sistema para predecir el riesgo de incumplimiento de manera m치s efectiva.

El estudio evidencia la importancia del uso de t칠cnicas de an치lisis multivariado y de aprendizaje autom치tico para la segmentaci칩n y evaluaci칩n del riesgo financiero. No obstante, las limitaciones en la sensibilidad del modelo destacan la necesidad de seguir optimizando las estrategias de clasificaci칩n para mejorar su aplicaci칩n en contextos reales.